{% liquid
  assign show_description = block.settings.show_description
  assign description_html = product.description
  assign description_text = description_html | replace: '<!---->', '' | strip_html | strip
  assign has_description = false
  if show_description and description_html != blank and description_text != ''
    assign has_description = true
  endif

  assign read_more_enabled = block.settings.show_read_more
  assign collapsed_height = block.settings.collapsed_height | default: 160
  assign read_more_label = block.settings.read_more_label | default: 'READ MORE'
  assign read_less_label = block.settings.read_less_label | default: 'COLLAPSE'
  assign arrow_variants = '▾|▿|▴|▵|▼|▽|▲|△'
  assign arrow_array = arrow_variants | split: '|'
  for arrow in arrow_array
    assign read_more_label = read_more_label | replace: arrow, ''
    assign read_less_label = read_less_label | replace: arrow, ''
  endfor
  assign read_more_label = read_more_label | strip
  assign read_less_label = read_less_label | strip
  if read_more_label == blank
    assign read_more_label = 'READ MORE'
  endif
  if read_less_label == blank
    assign read_less_label = 'COLLAPSE'
  endif

  assign tab_count = 0
  if has_description
    assign tab_count = tab_count | plus: 1
  endif

  for i in (1..5)
    assign title_key = 'title_' | append: i
    assign content_key = 'raw_content_' | append: i
    assign title = block.settings[title_key]
    assign content = block.settings[content_key]
    assign content_text = content | replace: '<!---->', '' | strip_html | strip

    if title != blank
      assign tab_count = tab_count | plus: 1
    endif
  endfor
%}

{% if tab_count > 0 %}
  {% liquid
    assign tab_index = 0
    assign first_tab_id = ''
    assign description_label = 'products.product.description' | t
    assign description_label_check = description_label | downcase
    if description_label_check contains 'translation missing'
      assign description_label = 'Description'
    endif
  %}

  <tabs-component class="product-tabs" data-read-more="{{ read_more_enabled }}">
    <native-scrollbar class="tabs__head product-tabs__head">
      <ul
        class="tabs product-tabs-title"
        data-scrollbar
        data-scrollbar-slider
        role="tablist"
      >
        {% if has_description %}
          {% assign tab_index = tab_index | plus: 1 %}
          {% assign tab_id = 'tab-' | append: block.id | append: '-' | append: tab_index %}
          {% assign first_tab_id = tab_id %}
          <li class="tabs__item">
            <button
              class="tab-link current"
              data-tab="{{ tab_id }}"
              id="{{ tab_id }}-label"
              role="tab"
              aria-selected="true"
              aria-controls="{{ tab_id }}-panel"
              tabindex="0"
              type="button"
            >
              {{ description_label }}
            </button>
          </li>
        {% endif %}

        {% for i in (1..5) %}
          {% liquid
            assign title_key = 'title_' | append: i
            assign content_key = 'raw_content_' | append: i
            assign title = block.settings[title_key]
            assign content = block.settings[content_key]
            assign content_text = content | replace: '<!---->', '' | strip_html | strip
          %}

          {% if title != blank %}
            {% assign tab_index = tab_index | plus: 1 %}
            {% assign tab_id = 'tab-' | append: block.id | append: '-' | append: tab_index %}
            {% if first_tab_id == '' %}
              {% assign first_tab_id = tab_id %}
            {% endif %}

            <li class="tabs__item">
              <button
                class="tab-link{% if tab_id == first_tab_id %} current{% endif %}"
                data-tab="{{ tab_id }}"
                id="{{ tab_id }}-label"
                role="tab"
                aria-selected="{% if tab_id == first_tab_id %}true{% else %}false{% endif %}"
                aria-controls="{{ tab_id }}-panel"
                tabindex="{% if tab_id == first_tab_id %}0{% else %}-1{% endif %}"
                type="button"
              >
                {{- title -}}
              </button>
            </li>
          {% endif %}
        {% endfor %}
      </ul>

      <div class="product-tabs__arrows">
        <button
          class="tabs__arrow tabs__arrow--prev"
          type="button"
          aria-label="Previous tab"
          data-tabs-prev
        >
          {{- 'icon-chevron-left.svg' | inline_asset_content -}}
        </button>
        <button
          class="tabs__arrow tabs__arrow--next"
          type="button"
          aria-label="Next tab"
          data-tabs-next
        >
          {{- 'icon-chevron-right.svg' | inline_asset_content -}}
        </button>
      </div>
    </native-scrollbar>

    <div class="tabs__body product-tabs__body">
      {% assign tab_index = 0 %}

      {% if has_description %}
        {% assign tab_index = tab_index | plus: 1 %}
        {% assign tab_id = 'tab-' | append: block.id | append: '-' | append: tab_index %}
        {% assign content_id = 'ProductTabsDescription-' | append: block.id %}
        <div
          class="tab-content{% if tab_id == first_tab_id %} current{% endif %}"
          id="{{ tab_id }}-panel"
          role="tabpanel"
          aria-labelledby="{{ tab_id }}-label"
          {% if tab_id != first_tab_id %}hidden{% endif %}
          data-tab-content="{{ tab_id }}"
        >
          {% if read_more_enabled %}
            <div
              class="product-description-read-more"
              data-pdp-description-root
              data-collapsed-height="{{ collapsed_height }}"
            >
              <div
                class="product-description-read-more__content"
                id="{{ content_id }}"
                data-pdp-description-content
              >
                {{- description_html -}}
              </div>
              <div
                class="product-description-read-more__fade"
                data-pdp-description-fade
                aria-hidden="true"
              ></div>
              <button
                class="product-description-read-more__toggle"
                type="button"
                aria-expanded="false"
                aria-controls="{{ content_id }}"
                data-pdp-description-toggle
                data-read-more-label="{{ read_more_label }}"
                data-read-less-label="{{ read_less_label }}"
              >
                <span data-pdp-description-toggle-label>{{ read_more_label }}</span>
              </button>
            </div>
          {% else %}
            {{- description_html -}}
          {% endif %}
        </div>
      {% endif %}

      {% for i in (1..5) %}
        {% liquid
          assign title_key = 'title_' | append: i
          assign content_key = 'raw_content_' | append: i
          assign title = block.settings[title_key]
          assign content = block.settings[content_key]
          assign content_text = content | replace: '<!---->', '' | strip_html | strip
        %}

        {% if title != blank %}
          {% assign tab_index = tab_index | plus: 1 %}
          {% assign tab_id = 'tab-' | append: block.id | append: '-' | append: tab_index %}
          <div
            class="tab-content{% if tab_id == first_tab_id %} current{% endif %}"
            id="{{ tab_id }}-panel"
            role="tabpanel"
            aria-labelledby="{{ tab_id }}-label"
            {% if tab_id != first_tab_id %}hidden{% endif %}
            data-tab-content="{{ tab_id }}"
          >
            {{- content -}}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </tabs-component>
  {% if has_description and read_more_enabled %}
    {% style %}
      .product-description-read-more {
        --pdp-description-collapsed-height: {{ collapsed_height }}px;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .product-description-read-more__content {
        max-height: var(--pdp-description-collapsed-height);
        overflow: hidden;
        transition: max-height 320ms ease;
        position: relative;
        z-index: 1;
      }

      .product-description-read-more[data-state='expanded'] .product-description-read-more__content {
        max-height: var(--pdp-description-expanded-height, 999vh);
      }

      .product-description-read-more[data-state='collapsed'] .product-description-read-more__content {
        max-height: var(--pdp-description-collapsed-height);
      }

      .product-description-read-more[data-state='static'] .product-description-read-more__content {
        max-height: none;
      }

      .product-description-read-more__fade {
        position: absolute;
        left: 0;
        right: 0;
        height: clamp(72px, 28%, 160px);
        bottom: 0;
        background: linear-gradient(
          180deg,
          rgb(var(--color-background-rgb, 255 255 255) / 0) 0%,
          rgb(var(--color-background-rgb, 255 255 255) / 0.6) 45%,
          rgb(var(--color-background-rgb, 255 255 255) / 1) 100%
        );
        pointer-events: none;
        opacity: 1;
        transition: opacity 160ms ease;
        z-index: 2;
      }

      .product-description-read-more[data-state='expanded'] .product-description-read-more__fade,
      .product-description-read-more[data-state='static'] .product-description-read-more__fade {
        opacity: 0;
        visibility: hidden;
      }

      .product-description-read-more__toggle {
        align-self: center;
        appearance: none;
        -webkit-appearance: none;
        background: transparent;
        border: none;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin: 0;
        padding-top: 10px;
        font-size: 14px;
        text-decoration: underline;
        text-underline-offset: 4px;
        text-decoration-thickness: 1px;
        color: inherit;
        text-align: center;
        width: auto;
        position: relative;
        z-index: 3;
      }

      .product-description-read-more__toggle:focus-visible {
        outline: none;
        border-color: rgb(var(--color-foreground-rgb, 18 18 18) / 0.4);
      }

      .product-description-read-more[data-state='static'] .product-description-read-more__toggle {
        display: none;
      }
    {% endstyle %}
    <script>
      window.ProductDescriptionReadMore =
        window.ProductDescriptionReadMore ||
        (function () {
          const selectors = {
            root: '[data-pdp-description-root]'
          };

          const enhance = (scope = document) => {
            scope.querySelectorAll(selectors.root).forEach((root) => {
              if (root.dataset.enhanced === 'true') {
                return;
              }

              const content = root.querySelector('[data-pdp-description-content]');
              const fade = root.querySelector('[data-pdp-description-fade]');
              const toggle = root.querySelector('[data-pdp-description-toggle]');
              const labelTarget = toggle.querySelector('[data-pdp-description-toggle-label]') || toggle;
              const collapsed = Number(root.dataset.collapsedHeight) || 160;

              if (!content || !toggle) {
                return;
              }

              root.dataset.enhanced = 'true';
              const setExpandedHeight = () => {
                root.style.setProperty('--pdp-description-expanded-height', `${content.scrollHeight}px`);
              };

              const updateState = (expanded) => {
                root.dataset.state = expanded ? 'expanded' : 'collapsed';
                toggle.setAttribute('aria-expanded', expanded);
                labelTarget.textContent = expanded
                  ? toggle.dataset.readLessLabel || 'COLLAPSE'
                  : toggle.dataset.readMoreLabel || 'READ MORE';
              };

              const lockIfShort = () => {
                const isShort = content.scrollHeight <= collapsed + 10;
                if (isShort) {
                  root.dataset.state = 'static';
                  toggle.hidden = true;
                  if (fade) {
                    fade.hidden = true;
                  }
                  content.style.maxHeight = 'none';
                } else {
                  content.style.removeProperty('max-height');
                  toggle.hidden = false;
                  if (fade) {
                    fade.hidden = false;
                  }
                  setExpandedHeight();
                  updateState(false);
                }
              };

              const handleResize = () => {
                setExpandedHeight();
                if (root.dataset.state === 'static') {
                  lockIfShort();
                }
              };

              if ('ResizeObserver' in window) {
                const observer = new ResizeObserver(handleResize);
                observer.observe(content);
              } else {
                window.addEventListener('resize', handleResize);
              }

              lockIfShort();

              toggle.addEventListener('click', () => {
                if (root.dataset.state === 'static') {
                  return;
                }
                const willExpand = root.dataset.state !== 'expanded';
                if (willExpand) {
                  setExpandedHeight();
                }
                updateState(willExpand);
              });
            });
          };

          const onReady = () => enhance(document);
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', onReady, { once: true });
          } else {
            requestAnimationFrame(onReady);
          }

          document.addEventListener('shopify:section:load', (event) => enhance(event.target));

          return enhance;
        })();
      window.ProductDescriptionReadMore(document);
    </script>
  {% endif %}
{% endif %}
