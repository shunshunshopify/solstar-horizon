{% liquid
  assign show_read_more = show_read_more | default: false
  assign collapsed_height = collapsed_height | default: 160
  assign read_more_label = read_more_label | default: 'read_more' | t
  assign read_less_label = read_less_label | default: 'read_less' | t

  assign arrow_variants = '▾|▿|▴|▵|▼|▽|▲|△'
  assign arrow_array = arrow_variants | split: '|'
  for arrow in arrow_array
    assign read_more_label = read_more_label | replace: arrow, ''
    assign read_less_label = read_less_label | replace: arrow, ''
  endfor
  assign read_more_label = read_more_label | strip
  assign read_less_label = read_less_label | strip
  if read_more_label == blank
    assign read_more_label = 'READ MORE'
  endif
  if read_less_label == blank
    assign read_less_label = 'COLLAPSE'
  endif

  assign content_id = 'ToggleEllipsis-' | append: block.id
  if forloop and forloop.index
    assign content_id = content_id | append: '-' | append: forloop.index
  endif
%}

{% if show_read_more %}
  <div
    class="product-description-read-more"
    data-pdp-description-root
    data-collapsed-height="{{ collapsed_height }}"
  >
    <div
      class="product-description-read-more__content"
      id="{{ content_id }}"
      data-pdp-description-content
    >
      {{- content -}}
    </div>
    <div
      class="product-description-read-more__fade"
      data-pdp-description-fade
      aria-hidden="true"
    ></div>
    <button
      class="product-description-read-more__toggle"
      type="button"
      aria-expanded="false"
      aria-controls="{{ content_id }}"
      data-pdp-description-toggle
      data-read-more-label="{{ read_more_label }}"
      data-read-less-label="{{ read_less_label }}"
    >
      <span data-pdp-description-toggle-label>{{ read_more_label }}</span>
    </button>
  </div>
  <script>
    (() => {
      if (!window.ProductDescriptionReadMore) {
        window.ProductDescriptionReadMore = (function () {
          const selectors = {
            root: '[data-pdp-description-root]',
          };

          const enhance = (scope = document) => {
            scope.querySelectorAll(selectors.root).forEach((root) => {
              if (root.dataset.enhanced === 'true') return;

              const content = root.querySelector('[data-pdp-description-content]');
              const fade = root.querySelector('[data-pdp-description-fade]');
              const toggle = root.querySelector('[data-pdp-description-toggle]');
              const labelTarget = toggle?.querySelector('[data-pdp-description-toggle-label]') || toggle;
              const collapsed = Number(root.dataset.collapsedHeight) || 160;

              if (!content || !toggle) return;

              root.dataset.enhanced = 'true';
              const setExpandedHeight = () => {
                root.style.setProperty('--pdp-description-expanded-height', `${content.scrollHeight}px`);
              };

              const updateState = (expanded) => {
                root.dataset.state = expanded ? 'expanded' : 'collapsed';
                toggle.setAttribute('aria-expanded', expanded);
                labelTarget.textContent = expanded
                  ? toggle.dataset.readLessLabel || 'COLLAPSE'
                  : toggle.dataset.readMoreLabel || 'READ MORE';
              };

              const lockIfShort = () => {
                const isShort = content.scrollHeight <= collapsed + 10;
                if (isShort) {
                  root.dataset.state = 'static';
                  toggle.hidden = true;
                  fade?.setAttribute('hidden', 'true');
                  content.style.maxHeight = 'none';
                } else {
                  content.style.removeProperty('max-height');
                  toggle.hidden = false;
                  fade?.removeAttribute('hidden');
                  setExpandedHeight();
                  updateState(false);
                }
              };

              lockIfShort();
              toggle.addEventListener('click', () => {
                const isExpanded = root.dataset.state === 'expanded';
                if (!isExpanded) setExpandedHeight();
                updateState(!isExpanded);
              });

              const resizeObserver = new ResizeObserver(lockIfShort);
              resizeObserver.observe(content);
            });
          };

          return enhance;
        })();
      }

      window.ProductDescriptionReadMore(document);
    })();
  </script>
{% else %}
  {{ content }}
{% endif %}
