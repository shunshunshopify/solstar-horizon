{% liquid
  assign product = block.settings.product
  if request.visual_preview_mode and product == blank
    assign product = collections.all.products.first
    assign text = product.description
  endif
%}

{% capture product_description_content %}
  {% render 'text', fallback_text: text, block: block %}
{% endcapture %}

{% if block.settings.enable_read_more %}
  {% assign collapsed_height = block.settings.collapsed_height | default: 160 %}
  {% assign content_id = 'ProductDescriptionContent-' | append: block.id %}
  <div
    class="product-description-read-more"
    data-pdp-description-root
    data-collapsed-height="{{ collapsed_height }}"
  >
    <div
      class="product-description-read-more__content"
      id="{{ content_id }}"
      data-pdp-description-content
    >
      {{ product_description_content }}
    </div>
    <div
      class="product-description-read-more__fade"
      data-pdp-description-fade
      aria-hidden="true"
    ></div>
    <button
      class="product-description-read-more__toggle"
      type="button"
      aria-expanded="false"
      aria-controls="{{ content_id }}"
      data-pdp-description-toggle
      data-read-more-label="{{ block.settings.read_more_label | default: 'READ MORE ▾' }}"
      data-read-less-label="{{ block.settings.read_less_label | default: 'COLLAPSE ▴' }}"
    >
      <span data-pdp-description-toggle-label>{{ block.settings.read_more_label | default: 'READ MORE ▾' }}</span>
    </button>
  </div>
  {% style %}
    .product-description-read-more {
      --pdp-description-collapsed-height: {{ collapsed_height }}px;
      position: relative;
    }

    .product-description-read-more__content {
      max-height: var(--pdp-description-collapsed-height);
      overflow: hidden;
      transition: max-height 320ms ease;
    }

    .product-description-read-more[data-state='expanded'] .product-description-read-more__content {
      max-height: var(--pdp-description-expanded-height, 999vh);
    }

    .product-description-read-more[data-state='collapsed'] .product-description-read-more__content {
      max-height: var(--pdp-description-collapsed-height);
    }

    .product-description-read-more[data-state='static'] .product-description-read-more__content {
      max-height: none;
    }

    .product-description-read-more__fade {
      position: absolute;
      left: 0;
      right: 0;
      height: clamp(48px, 22%, 120px);
      bottom: 3.25rem;
      background: linear-gradient(180deg, rgb(var(--color-background-rgb, 255 255 255) / 0) 0%, rgb(var(--color-background-rgb, 255 255 255) / 0.95) 100%);
      pointer-events: none;
      opacity: 1;
      transition: opacity 160ms ease;
    }

    .product-description-read-more[data-state='expanded'] .product-description-read-more__fade,
    .product-description-read-more[data-state='static'] .product-description-read-more__fade {
      opacity: 0;
    }

    .product-description-read-more__toggle {
      appearance: none;
      background: transparent;
      border: none;
      border-top: 1px solid rgb(var(--color-foreground-rgb, 18 18 18) / 0.16);
      width: 100%;
      margin-top: 1.5rem;
      padding-top: 0.75rem;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-weight: 500;
      display: inline-flex;
      justify-content: center;
      gap: 0.25em;
      color: inherit;
      cursor: pointer;
    }

    .product-description-read-more__toggle:focus-visible {
      outline: none;
      border-color: rgb(var(--color-foreground-rgb, 18 18 18) / 0.4);
    }

    .product-description-read-more[data-state='static'] .product-description-read-more__toggle {
      display: none;
    }
  {% endstyle %}
  <script>
    window.ProductDescriptionReadMore = window.ProductDescriptionReadMore || (function () {
      const selectors = {
        root: '[data-pdp-description-root]'
      };

      const enhance = (scope = document) => {
        scope.querySelectorAll(selectors.root).forEach((root) => {
          if (root.dataset.enhanced === 'true') {
            return;
          }

          const content = root.querySelector('[data-pdp-description-content]');
          const fade = root.querySelector('[data-pdp-description-fade]');
          const toggle = root.querySelector('[data-pdp-description-toggle]');
          const labelTarget = toggle.querySelector('[data-pdp-description-toggle-label]') || toggle;
          const collapsed = Number(root.dataset.collapsedHeight) || 160;

          if (!content || !toggle) {
            return;
          }

          root.dataset.enhanced = 'true';
          const setExpandedHeight = () => {
            root.style.setProperty('--pdp-description-expanded-height', `${content.scrollHeight}px`);
          };

          const updateState = (expanded) => {
            root.dataset.state = expanded ? 'expanded' : 'collapsed';
            toggle.setAttribute('aria-expanded', expanded);
            labelTarget.textContent = expanded
              ? toggle.dataset.readLessLabel || 'COLLAPSE ▴'
              : toggle.dataset.readMoreLabel || 'READ MORE ▾';
          };

          const lockIfShort = () => {
            const isShort = content.scrollHeight <= collapsed + 10;
            if (isShort) {
              root.dataset.state = 'static';
              toggle.hidden = true;
              if (fade) {
                fade.hidden = true;
              }
              content.style.maxHeight = 'none';
            } else {
              content.style.removeProperty('max-height');
              toggle.hidden = false;
              if (fade) {
                fade.hidden = false;
              }
              setExpandedHeight();
              updateState(false);
            }
          };

          const handleResize = () => {
            setExpandedHeight();
            if (root.dataset.state === 'static') {
              lockIfShort();
            }
          };

          if ('ResizeObserver' in window) {
            const observer = new ResizeObserver(handleResize);
            observer.observe(content);
          } else {
            window.addEventListener('resize', handleResize);
          }

          lockIfShort();

          toggle.addEventListener('click', () => {
            if (root.dataset.state === 'static') {
              return;
            }
            const willExpand = root.dataset.state !== 'expanded';
            if (willExpand) {
              setExpandedHeight();
            }
            updateState(willExpand);
          });
        });
      };

      const onReady = () => enhance(document);
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', onReady, { once: true });
      } else {
        requestAnimationFrame(onReady);
      }

      document.addEventListener('shopify:section:load', (event) => enhance(event.target));

      return enhance;
    })();
    window.ProductDescriptionReadMore(document);
  </script>
{% else %}
  {{ product_description_content }}
{% endif %}

{% schema %}
{
  "name": "t:names.text",
  "tag": null,
  "settings": [
    {
      "type": "richtext",
      "id": "text",
      "label": "t:settings.text"
    },
    {
      "type": "header",
      "content": "Read more toggle"
    },
    {
      "type": "checkbox",
      "id": "enable_read_more",
      "label": "Enable \"Read More\" toggle",
      "default": false
    },
    {
      "type": "range",
      "id": "collapsed_height",
      "label": "Collapsed height",
      "min": 80,
      "max": 400,
      "step": 10,
      "unit": "px",
      "default": 160,
      "visible_if": "{{ block.settings.enable_read_more }}"
    },
    {
      "type": "text",
      "id": "read_more_label",
      "label": "\"Read more\" label",
      "default": "READ MORE ▾",
      "visible_if": "{{ block.settings.enable_read_more }}"
    },
    {
      "type": "text",
      "id": "read_less_label",
      "label": "\"Collapse\" label",
      "default": "COLLAPSE ▴",
      "visible_if": "{{ block.settings.enable_read_more }}"
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit"
        },
        {
          "value": "100%",
          "label": "t:options.fill"
        }
      ],
      "default": "fit-content"
    },
    {
      "type": "select",
      "id": "max_width",
      "label": "t:settings.max_width",
      "options": [
        {
          "value": "narrow",
          "label": "t:options.narrow"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "none",
          "label": "t:options.none"
        }
      ],
      "default": "normal"
    },
    {
      "type": "text_alignment",
      "id": "alignment",
      "label": "t:settings.alignment",
      "default": "left",
      "visible_if": "{{ block.settings.width == '100%' }}"
    },
    {
      "type": "header",
      "content": "t:content.typography"
    },
    {
      "type": "select",
      "id": "type_preset",
      "label": "t:settings.preset",
      "options": [
        {
          "value": "rte",
          "label": "t:options.default"
        },
        {
          "value": "paragraph",
          "label": "t:options.paragraph"
        },
        {
          "value": "h1",
          "label": "t:options.h1"
        },
        {
          "value": "h2",
          "label": "t:options.h2"
        },
        {
          "value": "h3",
          "label": "t:options.h3"
        },
        {
          "value": "h4",
          "label": "t:options.h4"
        },
        {
          "value": "h5",
          "label": "t:options.h5"
        },
        {
          "value": "h6",
          "label": "t:options.h6"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "rte",
      "info": "t:info.edit_presets_in_theme_settings"
    },
    {
      "type": "select",
      "id": "font",
      "label": "t:settings.font",
      "options": [
        {
          "value": "var(--font-body--family)",
          "label": "t:options.body"
        },
        {
          "value": "var(--font-subheading--family)",
          "label": "t:options.subheading"
        },
        {
          "value": "var(--font-heading--family)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--font-accent--family)",
          "label": "t:options.accent"
        }
      ],
      "default": "var(--font-body--family)",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "font_size",
      "label": "t:settings.size",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "0.625rem",
          "label": "10px"
        },
        {
          "value": "0.75rem",
          "label": "12px"
        },
        {
          "value": "0.875rem",
          "label": "14px"
        },
        {
          "value": "1rem",
          "label": "16px"
        },
        {
          "value": "1.125rem",
          "label": "18px"
        },
        {
          "value": "1.25rem",
          "label": "20px"
        },
        {
          "value": "1.5rem",
          "label": "24px"
        },
        {
          "value": "2rem",
          "label": "32px"
        },
        {
          "value": "2.5rem",
          "label": "40px"
        },
        {
          "value": "3rem",
          "label": "48px"
        },
        {
          "value": "3.5rem",
          "label": "56px"
        },
        {
          "value": "4.5rem",
          "label": "72px"
        },
        {
          "value": "5.5rem",
          "label": "88px"
        },
        {
          "value": "7.5rem",
          "label": "120px"
        },
        {
          "value": "9.5rem",
          "label": "152px"
        },
        {
          "value": "11.5rem",
          "label": "184px"
        }
      ],
      "default": "1rem",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "line_height",
      "label": "t:settings.line_height",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "letter_spacing",
      "label": "t:settings.letter_spacing",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "case",
      "label": "t:settings.case",
      "options": [
        {
          "value": "none",
          "label": "t:options.default"
        },
        {
          "value": "uppercase",
          "label": "t:options.uppercase"
        }
      ],
      "default": "none",
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "wrap",
      "label": "t:settings.wrap",
      "options": [
        {
          "value": "pretty",
          "label": "t:options.pretty"
        },
        {
          "value": "balance",
          "label": "t:options.balance"
        },
        {
          "value": "nowrap",
          "label": "t:options.none"
        }
      ],
      "visible_if": "{{ block.settings.type_preset == 'custom' }}"
    },
    {
      "type": "select",
      "id": "color",
      "label": "t:settings.color",
      "options": [
        {
          "value": "var(--color-foreground)",
          "label": "t:options.text"
        },
        {
          "value": "var(--color-foreground-heading)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--color-primary)",
          "label": "t:options.link"
        }
      ],
      "default": "var(--color-foreground)",
      "visible_if": "{{ block.settings.type_preset != 'rte' }}"
    },
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "checkbox",
      "id": "background",
      "label": "t:settings.background",
      "default": false
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "t:settings.background_color",
      "alpha": true,
      "default": "#00000026",
      "visible_if": "{{ block.settings.background }}"
    },
    {
      "type": "range",
      "id": "corner_radius",
      "label": "t:settings.corner_radius",
      "default": 0,
      "min": 0,
      "max": 50,
      "step": 1,
      "visible_if": "{{ block.settings.background }}"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.product_description",
      "category": "t:categories.product",
      "settings": {
        "text": "{{ closest.product.description }}"
      }
    }
  ]
}
{% endschema %}
