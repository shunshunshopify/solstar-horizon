{% liquid
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign columns = section.settings.columns | default: 4
  assign columns_gap = section.settings.columns_gap | default: 16
  assign slider_gutters = ''
  assign first_tab_id = ''

  if section.settings.section_width == 'page-width'
    assign slider_gutters = 'start end'
  endif
%}

<div class="section-background color-{{ section.settings.section_color_scheme }}"></div>

<section
  class="
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.section_color_scheme }}
    tab-collection
    section-resource-list
    spacing-style
    gap-style
  "
  style="
    {% render 'spacing-style', settings: section.settings %}
    {% render 'gap-style', value: section.settings.gap %}
  "
  data-section-id="{{ section.id }}"
>
  <div class="tab-collection__inner {% if section.settings.section_width == 'page-width' %}page-width{% endif %}">
    {% if heading or subheading %}
      <div class="tab-collection__header">
        {% if heading %}
          <h2 class="tab-collection__heading">{{ heading }}</h2>
        {% endif %}
        {% if subheading %}
          <div class="tab-collection__subheading rte">{{ subheading }}</div>
        {% endif %}
      </div>
    {% endif %}

    {% if section.blocks.size > 0 %}
      <tabs-component class="product-tabs tab-collection__tabs" data-tabs-no-scroll>
        <native-scrollbar class="tabs__head product-tabs__head">
          <ul class="tabs product-tabs-title" role="tablist" data-scrollbar data-scrollbar-slider>
            {% for block in section.blocks %}
              {% liquid
                assign tab_id = 'TabCollection-' | append: section.id | append: '-' | append: block.id
                assign tab_collection = block.settings.collection
                if tab_collection == blank
                  assign tab_collection = block.settings.collection_list | first
                endif
                assign label = block.settings.title

                if label == blank and tab_collection != blank
                  assign label = tab_collection.title
                endif

                if label == blank
                  assign label = 'Collection'
                endif

                if first_tab_id == ''
                  assign first_tab_id = tab_id
                endif
              %}
              <li class="tabs__item" {{ block.shopify_attributes }}>
                <button
                  class="tab-link{% if tab_id == first_tab_id %} current{% endif %}"
                  data-tab="{{ tab_id }}"
                  id="{{ tab_id }}-label"
                  role="tab"
                  aria-selected="{% if tab_id == first_tab_id %}true{% else %}false{% endif %}"
                  aria-controls="{{ tab_id }}-panel"
                  tabindex="{% if tab_id == first_tab_id %}0{% else %}-1{% endif %}"
                  type="button"
                >
                  {{- label -}}
                </button>
              </li>
            {% endfor %}
          </ul>

          <div class="product-tabs__arrows">
            <button
              class="tabs__arrow tabs__arrow--prev"
              type="button"
              aria-label="Previous tab"
              data-tabs-prev
            >
              {{- 'icon-chevron-left.svg' | inline_asset_content -}}
            </button>
            <button
              class="tabs__arrow tabs__arrow--next"
              type="button"
              aria-label="Next tab"
              data-tabs-next
            >
              {{- 'icon-chevron-right.svg' | inline_asset_content -}}
            </button>
          </div>
        </native-scrollbar>

        <div class="tabs__body product-tabs__body tab-collection__panels">
          {% for block in section.blocks %}
            {% liquid
              assign tab_id = 'TabCollection-' | append: section.id | append: '-' | append: block.id
              assign tab_collection = block.settings.collection
              if tab_collection == blank
                assign tab_collection = block.settings.collection_list | first
              endif
              assign max_items = block.settings.max_items | default: 6
              assign slide_count = max_items

              if tab_collection != blank and tab_collection.products_count > 0
                assign slide_count = tab_collection.products_count | at_most: max_items
              endif

              assign image_ratio = 'adapt'
              case block.settings.image_ratio
                when 'landscape'
                  assign image_ratio = '16 / 9'
                when 'portrait'
                  assign image_ratio = '4 / 5'
                when 'square'
                  assign image_ratio = '1 / 1'
                when 'circle'
                  assign image_ratio = '1 / 1'
                when 'adapt'
                  assign image_ratio = 'adapt'
              endcase
            %}

            {% capture list_items %}
              {% if tab_collection != blank and tab_collection.products_count > 0 %}
                {% for tab_product in tab_collection.products limit: max_items %}
                  <div
                    class="
                      resource-list__item
                      tab-collection__item
                      border-style
                      {% if block.settings.inherit_color_scheme == false %} color-{{ block.settings.color_scheme }}{% endif %}
                    "
                    style="
                      {% render 'border-override', settings: block.settings %}
                      --resource-card-corner-radius: {{ block.settings.border_radius }}px;
                    "
                    data-origin-collection-handle="{{ tab_collection.handle }}"
                    data-origin-collection-title="{{ tab_collection.title | escape }}"
                    data-origin-collection-url="{{ tab_collection.url | escape }}"
                  >
                    {% render 'resource-card',
                      resource: tab_product,
                      resource_type: 'product',
                      image_aspect_ratio: image_ratio,
                      image_hover: settings.show_second_image_on_hover,
                      show_wishlist_button: true,
                      collection: tab_collection
                    %}
                  </div>
                  {% unless forloop.last %}
                    <!--@list/split-->
                  {% endunless %}
                {% endfor %}
              {% else %}
                {% for i in (1..max_items) %}
                  <div
                    class="
                      resource-list__item
                      tab-collection__item
                      border-style
                      {% if block.settings.inherit_color_scheme == false %} color-{{ block.settings.color_scheme }}{% endif %}
                    "
                    style="
                      {% render 'border-override', settings: block.settings %}
                      --resource-card-corner-radius: {{ block.settings.border_radius }}px;
                    "
                  >
                    {% render 'resource-card',
                      resource: blank,
                      resource_type: 'product',
                      image_aspect_ratio: image_ratio,
                      show_wishlist_button: false
                    %}
                  </div>
                  {% unless forloop.last %}
                    <!--@list/split-->
                  {% endunless %}
                {% endfor %}
              {% endif %}
            {% endcapture %}

            {% assign list_items_array = list_items | strip | split: '<!--@list/split-->' %}

            <div
              class="tab-content{% if tab_id == first_tab_id %} current{% endif %}"
              id="{{ tab_id }}-panel"
              role="tabpanel"
              aria-labelledby="{{ tab_id }}-label"
              data-tab-content="{{ tab_id }}"
              {% unless tab_id == first_tab_id %}hidden{% endunless %}
            >
              {% render 'resource-list',
                list_items: list_items,
                list_items_array: list_items_array,
                settings: section.settings,
                carousel_ref: 'TabCollectionCarousel-' | append: section.id | append: '-' | append: block.id,
                slide_count: slide_count,
                content_type: 'products',
                test_id: 'tab-collection-carousel'
              %}
            </div>
          {% endfor %}
        </div>
      </tabs-component>
    {% else %}
      <div class="tab-collection__empty">
        {{ 'sections.onboarding.no_content' | t | default: 'Add tabs to show collections.' }}
      </div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Tab collection",
  "tag": "section",
  "class": "tab-collection-section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Shop collections"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Text"
    },
    {
      "type": "select",
      "id": "layout_type",
      "label": "Layout type",
      "options": [
        { "value": "carousel", "label": "Carousel" }
      ],
      "default": "carousel"
    },
    {
      "type": "range",
      "id": "columns",
      "label": "Columns",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_gap",
      "label": "Horizontal gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "header",
      "content": "Carousel navigation"
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "Icon",
      "options": [
        { "value": "arrow", "label": "Arrows" },
        { "value": "chevron", "label": "Chevrons" },
        { "value": "arrows_large", "label": "Arrows large" },
        { "value": "chevron_large", "label": "Chevrons large" },
        { "value": "none", "label": "None" }
      ],
      "default": "arrow"
    },
    {
      "type": "select",
      "id": "icons_shape",
      "label": "Icon background",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "circle", "label": "Circle" },
        { "value": "square", "label": "Square" }
      ],
      "default": "none",
      "visible_if": "{{ section.settings.icons_style != 'none' }}"
    },
    {
      "type": "header",
      "content": "Section layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "options": [
        { "value": "page-width", "label": "Page width" },
        { "value": "full-width", "label": "Full width" }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Section gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color_scheme",
      "id": "section_color_scheme",
      "label": "Section color scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "Padding left",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "Padding right",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Tab title",
          "default": "Collection"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "range",
          "id": "max_items",
          "label": "Max products",
          "min": 1,
          "max": 16,
          "step": 1,
          "default": 6
        },
        {
          "type": "header",
          "content": "Appearance"
        },
        {
          "type": "checkbox",
          "id": "inherit_color_scheme",
          "label": "Inherit color scheme",
          "default": true
        },
        {
          "type": "color_scheme",
          "id": "color_scheme",
          "label": "Color scheme",
          "default": "scheme-1",
          "visible_if": "{{ block.settings.inherit_color_scheme == false }}"
        },
        {
          "type": "select",
          "id": "border",
          "label": "Border style",
          "options": [
            { "value": "none", "label": "None" },
            { "value": "solid", "label": "Solid" }
          ],
          "default": "none"
        },
        {
          "type": "range",
          "id": "border_width",
          "min": 0,
          "max": 10,
          "step": 0.5,
          "unit": "px",
          "label": "Border width",
          "default": 1,
          "visible_if": "{{ block.settings.border != 'none' }}"
        },
        {
          "type": "range",
          "id": "border_opacity",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Border opacity",
          "default": 100,
          "visible_if": "{{ block.settings.border != 'none' }}"
        },
        {
          "type": "range",
          "id": "border_radius",
          "label": "Border radius",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "px",
          "default": 0
        },
        {
          "type": "header",
          "content": "Image"
        },
        {
          "type": "select",
          "id": "image_ratio",
          "label": "Image aspect ratio",
          "info": "Auto uses the collection image ratio.",
          "options": [
            { "value": "adapt", "label": "Auto" },
            { "value": "portrait", "label": "Portrait" },
            { "value": "square", "label": "Square" },
            { "value": "circle", "label": "Circle" },
            { "value": "landscape", "label": "Landscape" }
          ],
          "default": "portrait"
        },
        {
          "type": "checkbox",
          "id": "toggle_overlay",
          "label": "Media overlay",
          "default": false
        },
        {
          "type": "color",
          "id": "overlay_color",
          "label": "Overlay color",
          "alpha": true,
          "default": "#00000026",
          "visible_if": "{{ block.settings.toggle_overlay }}"
        },
        {
          "type": "select",
          "id": "overlay_style",
          "label": "Overlay style",
          "options": [
            { "value": "solid", "label": "Solid" },
            { "value": "gradient", "label": "Gradient" }
          ],
          "default": "solid",
          "visible_if": "{{ block.settings.toggle_overlay }}"
        },
        {
          "type": "select",
          "id": "gradient_direction",
          "label": "Gradient direction",
          "options": [
            { "value": "to top", "label": "Up" },
            { "value": "to bottom", "label": "Down" }
          ],
          "default": "to top",
          "visible_if": "{{ block.settings.toggle_overlay and block.settings.overlay_style == 'gradient' }}"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Tab collection",
      "category": "Collections",
      "blocks": [
        { "type": "tab" },
        { "type": "tab" }
      ]
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .tab-collection__inner {
    width: 100%;
  }

  .tab-collection__header {
    display: grid;
    gap: 8px;
  }

  .tab-collection__heading {
    margin: 0;
  }

  .tab-collection__panels {
    margin-top: 12px;
    overflow-anchor: none;
  }

  .tab-collection__inner.page-width .tab-collection__panels {
    margin-inline: calc(-1 * var(--page-margin));
  }

  .tab-collection__panels .tab-content {
    overflow-anchor: none;
  }

  .tab-collection__empty {
    text-align: center;
    padding: var(--gap-xl);
    border: 1px dashed rgb(var(--color-border-rgb, 0 0 0) / 0.35);
    border-radius: var(--style-border-radius-cards, 12px);
  }
{% endstylesheet %}
