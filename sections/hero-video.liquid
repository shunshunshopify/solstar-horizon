{{ 'hero-video.css' | asset_url | stylesheet_tag }}

{% style %}

#shopify-section-{{ section.id }} {
  padding-block-start: {{ section.settings.padding-block-start }}px;
  padding-block-end: {{ section.settings.padding-block-end }}px;
  /* Set custom properties for dynamic text sizing */
  --hero-title-size-mobile: {{ section.settings.title_size | times: 0.5 }}px;
  --hero-title-size-desktop: {{ section.settings.title_size }}px;
  --hero-subtitle-size-mobile: {{ section.settings.subheading_size | times: 0.7 }}px;
  --hero-subtitle-size-desktop: {{ section.settings.subheading_size }}px;
}
 
.hero--{{ section.id }} .hero__media,
.hero--{{ section.id }} .hero__media iframe{
    width: 100%;
    height: 100%;
}
.hero--{{ section.id }} .hero-video__media--mobile {
  display: none;
}
@media (max-width: 768px) {
  .hero--{{ section.id }} .hero-video__media--desktop {
    display: none;
  }
  .hero--{{ section.id }} .hero-video__media--mobile {
    display: block;
  }
}

{% if section.settings.overlay_opacity > 0 %}
  .hero--{{ section.id }} .hero__text-wrap:after {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  background-color: #000;
  opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }};
  z-index: -1;
  }
{% endif %}

{% comment %} Since we always have a video (either custom or a placeholder), text should always be white {% endcomment %}
.hero__title, .hero__subtitle{
  color: #fff;
  opacity: 1;
}

.hero--{{ section.id }} .hero-video__placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.hero--{{ section.id }} .hero-video__placeholder-svg {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

{% endstyle %}

<div
  data-section-id="{{ section.id }}"
  class="video-parent-section hero--{{ section.id }} hero--{{ section.settings.section_height }} hero--mobile--{{ section.settings.mobile_height }}"
  role="banner"
  aria-label="Hero video section"
  >

  <div class="hero__media hero__media--{{ section.id }}" style="position: absolute; top: 0; left: 0; z-index: -1;" aria-hidden="true">

    {%- liquid
      assign desktop_video_source = section.settings.video_source | default: 'external'
      assign desktop_uploaded_video = section.settings.video_uploaded
      assign desktop_video_url = section.settings.video_url | strip

      assign mobile_video_source = section.settings.video_source_mobile | default: desktop_video_source
      assign mobile_uploaded_video = section.settings.video_uploaded_mobile
      assign mobile_video_url = section.settings.video_url_mobile | strip

      assign has_desktop_uploaded = desktop_video_source == 'uploaded' and desktop_uploaded_video != blank
      assign has_desktop_external = desktop_video_source == 'external' and desktop_video_url != blank

      assign has_mobile_uploaded = mobile_video_source == 'uploaded' and mobile_uploaded_video != blank
      assign has_mobile_external = mobile_video_source == 'external' and mobile_video_url != blank

      if has_mobile_uploaded == false and has_mobile_external == false
        assign mobile_video_source = desktop_video_source
        assign mobile_uploaded_video = desktop_uploaded_video
        assign mobile_video_url = desktop_video_url
        assign has_mobile_uploaded = has_desktop_uploaded
        assign has_mobile_external = has_desktop_external
      endif

      assign has_any_video = false
      if has_desktop_uploaded or has_desktop_external or has_mobile_uploaded or has_mobile_external
        assign has_any_video = true
      endif

      assign desktop_is_mp4 = false
      if has_desktop_external and desktop_video_url != blank
        assign desktop_is_mp4 = desktop_video_url | slice: -4, 4 | downcase
        assign desktop_is_mp4 = desktop_is_mp4 == '.mp4'
      endif

      assign mobile_is_mp4 = false
      if has_mobile_external and mobile_video_url != blank
        assign mobile_is_mp4 = mobile_video_url | slice: -4, 4 | downcase
        assign mobile_is_mp4 = mobile_is_mp4 == '.mp4'
      endif

      assign desktop_youtube_id = ''
      if has_desktop_external and desktop_is_mp4 == false
        assign clean_url = desktop_video_url | strip
        if clean_url contains 'youtu.be/'
          assign url_parts = clean_url | split: 'youtu.be/'
          if url_parts.size > 1
            assign id_part = url_parts[1] | split: '?' | first | split: '&' | first | split: '#' | first | split: '/' | first | strip
            if id_part.size == 11
              assign desktop_youtube_id = id_part
            endif
          endif
        elsif clean_url contains 'youtube.com'
          if clean_url contains 'v='
            assign url_parts = clean_url | split: 'v='
            if url_parts.size > 1
              assign id_part = url_parts[1] | split: '&' | first | split: '#' | first | strip
              if id_part.size == 11
                assign desktop_youtube_id = id_part
              endif
            endif
          elsif clean_url contains 'embed/'
            assign url_parts = clean_url | split: 'embed/'
            if url_parts.size > 1
              assign id_part = url_parts[1] | split: '?' | first | split: '&' | first | split: '/' | first | strip
              if id_part.size == 11
                assign desktop_youtube_id = id_part
              endif
            endif
          endif
        endif
      endif

      assign mobile_youtube_id = ''
      if has_mobile_external and mobile_is_mp4 == false
        assign clean_url = mobile_video_url | strip
        if clean_url contains 'youtu.be/'
          assign url_parts = clean_url | split: 'youtu.be/'
          if url_parts.size > 1
            assign id_part = url_parts[1] | split: '?' | first | split: '&' | first | split: '#' | first | split: '/' | first | strip
            if id_part.size == 11
              assign mobile_youtube_id = id_part
            endif
          endif
        elsif clean_url contains 'youtube.com'
          if clean_url contains 'v='
            assign url_parts = clean_url | split: 'v='
            if url_parts.size > 1
              assign id_part = url_parts[1] | split: '&' | first | split: '#' | first | strip
              if id_part.size == 11
                assign mobile_youtube_id = id_part
              endif
            endif
          elsif clean_url contains 'embed/'
            assign url_parts = clean_url | split: 'embed/'
            if url_parts.size > 1
              assign id_part = url_parts[1] | split: '?' | first | split: '&' | first | split: '/' | first | strip
              if id_part.size == 11
                assign mobile_youtube_id = id_part
              endif
            endif
          endif
        endif
      endif
    -%}

    {% if has_any_video %}
      <div class="hero-video__media hero-video__media--desktop" data-hero-video-media="desktop">
        {% if has_desktop_uploaded %}
          {{
            desktop_uploaded_video
            | video_tag:
              autoplay: false,
              loop: true,
              muted: true,
              controls: false,
              playsinline: true,
              class: 'video-div',
              id: 'UploadedVideo-Desktop-' | append: section.id
          }}
        {% elsif has_desktop_external %}
          {% if desktop_is_mp4 %}
            <video
              id="Mp4Video-Desktop-{{ section.id }}"
              class="video-div"
              src="{{ desktop_video_url }}"
              data-type="mp4"
              data-hero-video-el="desktop"
              aria-label="Background video"
              aria-hidden="true"
              loop
              muted
              playsinline
              preload="metadata"
            ></video>
          {% else %}
            <div
              id="youtube-player-desktop-{{ section.id }}"
              class="youtube-video-container"
              aria-label="Background video player"
              aria-hidden="true"
              role="img"
              data-hero-youtube-container="desktop"
              data-video-id="{{ desktop_youtube_id }}"
            ></div>
          {% endif %}
        {% endif %}
      </div>

      <div class="hero-video__media hero-video__media--mobile" data-hero-video-media="mobile">
        {% if has_mobile_uploaded %}
          {{
            mobile_uploaded_video
            | video_tag:
              autoplay: false,
              loop: true,
              muted: true,
              controls: false,
              playsinline: true,
              class: 'video-div',
              id: 'UploadedVideo-Mobile-' | append: section.id
          }}
        {% elsif has_mobile_external %}
          {% if mobile_is_mp4 %}
            <video
              id="Mp4Video-Mobile-{{ section.id }}"
              class="video-div"
              src="{{ mobile_video_url }}"
              data-type="mp4"
              data-hero-video-el="mobile"
              aria-label="Background video"
              aria-hidden="true"
              loop
              muted
              playsinline
              preload="metadata"
            ></video>
          {% else %}
            <div
              id="youtube-player-mobile-{{ section.id }}"
              class="youtube-video-container"
              aria-label="Background video player"
              aria-hidden="true"
              role="img"
              data-hero-youtube-container="mobile"
              data-video-id="{{ mobile_youtube_id }}"
            ></div>
          {% endif %}
        {% endif %}
      </div>

      <style>
        #shopify-section-{{ section.id }}{
          position: relative !important;
        }
        .hero--{{ section.id }} .hero__media iframe {
          position: absolute !important;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }
      </style>

      <script type="module">
        import YouTubeManager from '@theme/youtube-manager';

        const sectionId = '{{ section.id }}';
        const desktopContainerId = `youtube-player-desktop-${sectionId}`;
        const mobileContainerId = `youtube-player-mobile-${sectionId}`;
        const desktopYouTubeId = '{{ desktop_youtube_id }}';
        const mobileYouTubeId = '{{ mobile_youtube_id }}';

        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const mobileQuery = window.matchMedia('(max-width: 768px)');

        function debounce(func, wait = 100) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }

        function resizeYouTube(containerId) {
          const container = document.getElementById(containerId);
          if (!container) return;
          const iframe = container.querySelector('iframe');
          if (!iframe) return;

          const parentContainer = container.parentElement;
          if (!parentContainer) return;

          const containerWidth = parentContainer.offsetWidth;
          const containerHeight = parentContainer.offsetHeight;
          const aspectRatio = 16 / 9;

          let newWidth, newHeight;
          if (containerWidth / containerHeight > aspectRatio) {
            newWidth = containerWidth;
            newHeight = containerWidth / aspectRatio;
          } else {
            newWidth = containerHeight * aspectRatio;
            newHeight = containerHeight;
          }

          iframe.style.width = newWidth + 'px';
          iframe.style.height = newHeight + 'px';
          iframe.style.position = 'absolute';
          iframe.style.left = (containerWidth - newWidth) / 2 + 'px';
          iframe.style.top = (containerHeight - newHeight) / 2 + 'px';
        }

        async function ensureYouTubePlayer(containerId, videoId) {
          if (!videoId || videoId.trim().length !== 11) return;
          if (prefersReducedMotion) return;

          await YouTubeManager.createPlayer(containerId, videoId, {
            playerVars: {
              autoplay: 1,
              mute: 1,
              loop: 1,
              playlist: videoId,
              controls: 0,
              showinfo: 0,
              rel: 0,
              modestbranding: 1,
              playsinline: 1,
              fs: 0,
              iv_load_policy: 3
            }
          });

          window.setTimeout(() => resizeYouTube(containerId), 100);
        }

        function pauseVideos(rootSelector) {
          document.querySelectorAll(`${rootSelector} video`).forEach((video) => {
            try {
              video.pause();
            } catch (e) {}
          });
        }

        function playVideos(rootSelector) {
          if (prefersReducedMotion) return;
          document.querySelectorAll(`${rootSelector} video`).forEach((video) => {
            try {
              video.muted = true;
              const playPromise = video.play();
              if (playPromise && typeof playPromise.catch === 'function') playPromise.catch(() => {});
            } catch (e) {}
          });
        }

        let activeMode = null;

        async function setActiveMode(nextMode) {
          if (activeMode === nextMode) return;
          activeMode = nextMode;

          // Pause inactive HTML5 videos
          pauseVideos('[data-hero-video-media="desktop"]');
          pauseVideos('[data-hero-video-media="mobile"]');

          // Destroy inactive YouTube players
          try { YouTubeManager.destroyPlayer(desktopContainerId); } catch (e) {}
          try { YouTubeManager.destroyPlayer(mobileContainerId); } catch (e) {}

          if (nextMode === 'mobile') {
            playVideos('[data-hero-video-media="mobile"]');
            await ensureYouTubePlayer(mobileContainerId, mobileYouTubeId || desktopYouTubeId);
          } else {
            playVideos('[data-hero-video-media="desktop"]');
            await ensureYouTubePlayer(desktopContainerId, desktopYouTubeId);
          }
        }

        const debouncedResize = debounce(() => {
          if (activeMode === 'mobile') resizeYouTube(mobileContainerId);
          if (activeMode === 'desktop') resizeYouTube(desktopContainerId);
        }, 150);

        document.addEventListener('DOMContentLoaded', async () => {
          await setActiveMode(mobileQuery.matches ? 'mobile' : 'desktop');
        });

        const onMobileQueryChange = async (event) => {
          await setActiveMode(event.matches ? 'mobile' : 'desktop');
        };
        if (typeof mobileQuery.addEventListener === 'function') {
          mobileQuery.addEventListener('change', onMobileQueryChange);
        } else if (typeof mobileQuery.addListener === 'function') {
          mobileQuery.addListener(onMobileQueryChange);
        }

        window.addEventListener('resize', debouncedResize);

        document.addEventListener('shopify:section:load', () => {
          window.setTimeout(() => debouncedResize(), 100);
        });
      </script>
    {% else %}
      <div class="hero-video__placeholder" aria-hidden="true">
        {{ 'hero-apparel-3' | placeholder_svg_tag: 'placeholder-svg hero-video__placeholder-svg' }}
      </div>
    {% endif %}
  </div>

  <div class="hero__container spacing-style section section--full-width">
    <div class="hero__text-wrap hero__content-wrapper page-width" role="main">
      <div class="hero__text-content {{ section.settings.text_align }}">
        {%- liquid
          assign title_html = section.settings.title
          assign subheading_html = section.settings.subheading

          if title_html != blank
            unless title_html contains '<'
              assign title_html = '<p>' | append: title_html | append: '</p>'
            endunless
          endif

          if subheading_html != blank
            unless subheading_html contains '<'
              assign subheading_html = '<p>' | append: subheading_html | append: '</p>'
            endunless
          endif
        -%}

        {%- unless title_html == blank -%}
          <div class="hero__title" id="hero-title-{{ section.id }}">
            {{ title_html }}
          </div>
        {%- endunless -%}
        {%- unless subheading_html == blank -%}
          <div
            class="hero__subtitle"
            {%- unless section.settings.title == blank -%}aria-describedby="hero-title-{{ section.id }}"{%- endunless -%}
          >
            {{ subheading_html }}
          </div>
        {%- endunless -%}
        {%- if section.settings.link_text != blank -%}
          <div class="hero__link color-{{ section.settings.color_scheme }}">
            {%- if section.settings.link != blank -%}
              <a href="{{ section.settings.link }}" 
                 class="{{ section.settings.style_class }}"
                 aria-label="{{ section.settings.link_text | escape }} - {{ section.settings.title | strip_html | escape }}">
                {{ section.settings.link_text }}
              </a>
            {%- else -%}
              <span class="{{ section.settings.style_class }}" 
                    style="cursor: default;"
                    role="text"
                    aria-label="Text only: {{ section.settings.link_text | escape }}">
                {{ section.settings.link_text }}
              </span>
            {%- endif -%}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>
 
{% schema %}
{
  "name": "t:names.hero_video",
  "tag": "section",
  "class": "index-section--hero",
  "settings": [
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "richtext",
      "id": "title",
      "label": "t:sections.hero_video.settings.title.label",
      "default": "<p>This is heading</p>"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "t:sections.hero_video.settings.title_size.label",
      "default": 80,
      "min": 40,
      "max": 100,
      "unit": "px"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "t:sections.hero_video.settings.subheading.label",
      "default": "<p>This is subheading</p>"
    },
    {
      "type": "range",
      "id": "subheading_size",
      "label": "t:sections.hero_video.settings.subheading_size.label",
      "default": 40,
      "min": 16,
      "max": 60,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "text_align",
      "label": "t:sections.hero_video.settings.text_align.label",
      "default": "vertical-center horizontal-center",
      "options": [
        {
          "value": "vertical-center horizontal-left",
          "label": "t:sections.hero_video.settings.text_align.options.center_left"
        },
        {
          "value": "vertical-center horizontal-center",
          "label": "t:sections.hero_video.settings.text_align.options.center"
        },
        {
          "value": "vertical-center horizontal-right",
          "label": "t:sections.hero_video.settings.text_align.options.center_right"
        },
        {
          "value": "vertical-bottom horizontal-left",
          "label": "t:sections.hero_video.settings.text_align.options.bottom_left"
        },
        {
          "value": "vertical-bottom horizontal-center",
          "label": "t:sections.hero_video.settings.text_align.options.bottom_center"
        },
        {
          "value": "vertical-bottom horizontal-right",
          "label": "t:sections.hero_video.settings.text_align.options.bottom_right"
        }
      ]
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "text",
      "id": "link_text",
      "label": "t:sections.hero_video.settings.link_text.label",
      "default": "Button"
    },
    {
      "type": "url",
      "id": "link",
      "label": "t:sections.hero_video.settings.link.label"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "style_class",
      "label": "t:settings.style",
      "options": [
        {
          "value": "button",
          "label": "t:options.primary"
        },
        {
          "value": "button-secondary",
          "label": "t:options.secondary"
        },
        {
          "value": "link",
          "label": "t:options.link"
        }
      ],
      "default": "button"
    },
    {
      "type": "header",
      "content": "Video"
    },
    {
      "type": "select",
      "id": "video_source",
      "label": "Source",
      "default": "external",
      "options": [
        { "value": "uploaded", "label": "Uploaded" },
        { "value": "external", "label": "External URL" }
      ]
    },
    {
      "type": "video",
      "id": "video_uploaded",
      "label": "Uploaded video",
      "visible_if": "{{ section.settings.video_source == 'uploaded' }}"
    },
    {
      "type": "text",
      "id": "video_url",
      "label": "Desktop video",
      "info": "t:sections.hero_video.settings.video_url.info",
      "visible_if": "{{ section.settings.video_source == 'external' }}"
    },
    {
      "type": "select",
      "id": "video_source_mobile",
      "label": "Mobile source",
      "default": "external",
      "options": [
        { "value": "uploaded", "label": "Uploaded" },
        { "value": "external", "label": "External URL" }
      ]
    },
    {
      "type": "video",
      "id": "video_uploaded_mobile",
      "label": "Mobile uploaded video",
      "visible_if": "{{ section.settings.video_source_mobile == 'uploaded' }}"
    },
    {
      "type": "text",
      "id": "video_url_mobile",
      "label": "Mobile video",
      "info": "Youtube or .MP4 - If left empty, desktop video will be used on mobile",
      "visible_if": "{{ section.settings.video_source_mobile == 'external' }}"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "t:sections.hero_video.settings.overlay_opacity.label",
      "info": "t:sections.hero_video.settings.overlay_opacity.info",
      "default": 0,
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "section_height",
      "label": "t:sections.hero_video.settings.section_height.label",
      "default": "650px",
      "options": [
        {
          "label": "16:9",
          "value": "16-9"
        },
        {
          "label": "450px",
          "value": "450px"
        },
        {
          "label": "550px",
          "value": "550px"
        },
        {
          "label": "650px",
          "value": "650px"
        },
        {
          "label": "750px",
          "value": "750px"
        },
        {
          "label": "t:sections.hero_video.settings.section_height.options.full_screen",
          "value": "100vh"
        }
      ]
    },
    {
      "type": "select",
      "id": "mobile_height",
      "label": "t:sections.hero_video.settings.mobile_height.label",
      "default": "auto",
      "options": [
        {
          "label": "t:sections.hero_video.settings.mobile_height.options.auto",
          "value": "auto"
        },
        {
          "label": "250px",
          "value": "250px"
        },
        {
          "label": "300px",
          "value": "300px"
        },
        {
          "label": "400px",
          "value": "400px"
        },
        {
          "label": "500px",
          "value": "500px"
        },
        {
          "label": "t:sections.hero_video.settings.mobile_height.options.iphone_height",
          "value": "850px"
        }
      ]
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.hero_video"
    }
  ]
}
{% endschema %}
