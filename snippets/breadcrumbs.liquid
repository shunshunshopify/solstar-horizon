{% if settings.show_breadcrumbs %}
  {%- liquid
    assign breadcrumb_collection = collection

    if breadcrumb_collection == blank and template contains 'product'
      assign request_path = request.path | downcase

      if request_path contains '/collections/'
        assign path_parts = request_path | split: '/collections/'
        if path_parts.size > 1
          assign after_collections = path_parts[1]
          assign after_collection_parts = after_collections | split: '/'
          assign collection_handle = after_collection_parts[0]

          if collection_handle != blank and product.collections.size > 0
            for product_collection in product.collections
              if product_collection.handle == collection_handle
                assign breadcrumb_collection = product_collection
                break
              endif
            endfor
          endif
        endif
      endif
    endif
  -%}
<nav class="breadcrumbs" role="navigation" aria-label="Breadcrumb">
  <div class="page-width page-width-{{ settings.page_width }}">
    <ol itemscope itemtype="https://schema.org/BreadcrumbList">
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{{ routes.root_url }}" itemprop="item">
          <span itemprop="name">Home</span>
        </a>
        <meta itemprop="position" content="1" />
      </li>

      {% if template contains 'product' and product %}
        {% if breadcrumb_collection %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ breadcrumb_collection.url }}" itemprop="item" data-breadcrumb-collection-link="true">
              <span itemprop="name">{{ breadcrumb_collection.title }}</span>
            </a>
            <meta itemprop="position" content="2" />
          </li>
        {% elsif product.collections.size > 0 %}
          {% assign first_collection = product.collections | first %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ first_collection.url }}" itemprop="item" data-breadcrumb-collection-link="true">
              <span itemprop="name">{{ first_collection.title }}</span>
            </a>
            <meta itemprop="position" content="2" />
          </li>
        {% endif %}
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <span itemprop="name">{{ product.title }}</span>
          <meta itemprop="position" content="3" />
        </li>

      {% elsif template contains 'collection' and collection %}
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <span itemprop="name">{{ collection.title }}</span>
          <meta itemprop="position" content="2" />
        </li>

      {% elsif template contains 'page' and page %}
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <span itemprop="name">{{ page.title }}</span>
          <meta itemprop="position" content="2" />
        </li>

      {% elsif template contains 'blog' %}
        {% if article %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ blog.url }}" itemprop="item">
              <span itemprop="name">{{ blog.title }}</span>
            </a>
            <meta itemprop="position" content="2" />
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">{{ article.title }}</span>
            <meta itemprop="position" content="3" />
          </li>
        {% else %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">{{ blog.title }}</span>
            <meta itemprop="position" content="2" />
          </li>
        {% endif %}
      {% endif %}
    </ol>
  </div>
</nav>
  {% if template contains 'product' and product %}
    <script>
      (() => {
        const storageKey = 'solstar:last_collection_for_product';
        if (typeof window === 'undefined' || !('localStorage' in window)) return;

        let rawPayload;
        try {
          rawPayload = window.localStorage.getItem(storageKey);
        } catch (_error) {
          return;
        }

        if (!rawPayload) return;

        let payload;
        try {
          payload = JSON.parse(rawPayload);
        } catch (_error) {
          try {
            window.localStorage.removeItem(storageKey);
          } catch (_removeError) {
            // noop
          }
          return;
        }

        if (!payload || typeof payload !== 'object') return;

        const now = Date.now();
        const maxAge = 1000 * 60 * 60 * 24;
        if (payload.timestamp && now - payload.timestamp > maxAge) {
          try {
            window.localStorage.removeItem(storageKey);
          } catch (_removeError) {
            // noop
          }
          return;
        }

        const matchesHandle = payload.productHandle && payload.productHandle === {{ product.handle | json }};
        const matchesId = payload.productId && Number(payload.productId) === Number({{ product.id | json }});
        if (!matchesHandle && !matchesId) return;
        if (!payload.collectionUrl || !payload.collectionTitle) return;

        const updateBreadcrumb = () => {
          const crumb = document.querySelector('[data-breadcrumb-collection-link]');
          if (!crumb) return;
          crumb.setAttribute('href', payload.collectionUrl);
          const labelNode = crumb.querySelector('[itemprop="name"]') || crumb;
          labelNode.textContent = payload.collectionTitle;

          if (payload.collectionHandle) {
            crumb.dataset.collectionHandle = payload.collectionHandle;
          }

          try {
            window.localStorage.removeItem(storageKey);
          } catch (_removeError) {
            // noop
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', updateBreadcrumb, { once: true });
        } else {
          updateBreadcrumb();
        }
      })();
    </script>
  {% endif %}
{% endif %}
